# 仓储监控系统 - 前端界面

基于Vue.js和Konva.js构建的实时仓储监控可视化界面，提供强大的编辑功能和直观的监控体验。

## 🌟 核心特性

- ✅ **实时监控可视化**：动态显示传送带状态和包裹流转
- ✅ **交互式传送带动画**：真实模拟包裹移动轨迹
- ✅ **包裹追踪和分拣模拟**：智能分拣算法和负载平衡
- ✅ **设备状态监控**：实时显示相机、摆轮等设备状态
- ✅ **高级编辑模式**：可视化布局编辑器
- ✅ **画布缩放和平移**：灵活的视图控制
- ✅ **传送带路径反转**：支持动态调整传送带方向
- ✅ **拖拽式设备定位**：直观的设备位置调整
- ✅ **设备和路径新增删除**：完整的编辑工具栏
- ✅ **设备方向切换**：相机、摆轮支持垂直/水平方向调整
- ✅ **传送带方向切换**：支持垂直/水平方向变换
- ✅ **设备智能跟随**：传送带方向切换时设备自动跟随调整
- ✅ **智能设备放置**：点击式和快速添加模式
- ✅ **响应式设计**：适配不同屏幕尺寸
- ✅ **夜间/白天主题**：支持主题切换
- ✅ **无感配置同步**：自动跨设备、跨浏览器配置同步

## 🚀 快速开始

### 安装依赖
```bash
cd warehouse-dashboard
npm install
```

### 开发模式
```bash
npm run dev
```

### 生产构建
```bash
npm run build
```

### 预览构建
```bash
npm run preview
```

## 🎛️ 编辑模式功能

### 视图控制
- **鼠标滚轮缩放**：在鼠标位置进行精确缩放
- **画布拖拽平移**：空白区域拖拽移动整个视图
- **缩放控制按钮**：放大、缩小、重置、适配屏幕
- **缩放范围**：0.2倍 - 3.0倍

### 路径编辑
- **节点拖拽**：调整传送带路径形状
- **路径反转**：一键反转传送带方向
- **约束编辑**：端点受方向约束，中间点自由移动
- **实时预览**：编辑时即时查看效果

### 设备管理
- **设备拖拽**：重新定位相机和摆轮
- **设备复制**：快速复制现有设备
- **设备删除**：移除不需要的设备
- **状态显示**：实时设备在线/离线状态

### 数据持久化
- **自动保存**：操作后自动保存到本地存储
- **手动保存**：💾 保存按钮确保数据安全
- **布局重置**：🔄 一键恢复默认布局

## 🏗️ 技术架构

### 核心技术栈
- **Vue 3**：现代化响应式框架
- **Konva.js**：高性能2D图形渲染
- **Vue-Konva**：Vue与Konva的集成组件
- **WebSocket**：实时数据通信
- **Vite**：快速构建工具

### 文件结构
```
src/
├── components/           # Vue组件
│   ├── ConveyorCanvas.vue   # 主画布组件
│   ├── CameraDevice.vue    # 相机设备组件
│   ├── Sorter.vue          # 摆轮设备组件
│   └── DraggableNode.vue   # 可拖拽节点组件
├── core/                # 核心逻辑
│   └── PathManager.js      # 路径管理器
├── services/            # 服务层
│   ├── WebSocketClient.js  # WebSocket客户端
│   └── WpfIntegrationConfig.js # WPF集成配置
└── assets/              # 静态资源
    ├── base.css            # 基础样式
    └── main.css            # 主样式
```

## 🔧 配置说明

### WebSocket配置
```javascript
// src/services/WpfIntegrationConfig.js
export const WpfConfig = {
  connection: {
    url: 'ws://127.0.0.1:8080',     // 主服务器地址
    reconnectInterval: 5000,         // 重连间隔
    maxReconnectAttempts: 10,        // 最大重连次数
    heartbeatInterval: 30000,        // 心跳间隔
  }
}
```

### 路径配置
```javascript
// src/core/PathManager.js
const dynamicPaths = {
  scan_line_1_start: { 
    direction: 'vertical', 
    points: [/* 路径坐标点 */] 
  },
  sku_line_1: { 
    direction: 'vertical', 
    points: [/* 路径坐标点 */] 
  },
  // 更多路径配置...
}
```

## 📖 使用指南

### 基础操作
1. **查看模式**：默认模式，查看实时监控数据
2. **编辑模式**：点击"编辑布局"按钮进入编辑模式
3. **主题切换**：点击主题按钮切换日夜间模式

### 编辑模式操作
1. **缩放视图**：使用鼠标滚轮或缩放按钮，快捷键 `+/-`
2. **平移画布**：在空白区域拖拽，或使用方向键 `↑↓←→`
3. **移动设备**：拖拽相机或摆轮到新位置
4. **调整路径**：拖拽路径节点改变形状
5. **反转传送带**：点击路径中心的反转按钮 ⟲
6. **删除分拣线**：点击路径中心的删除按钮 ×
7. **切换传送带方向**：点击路径中心的方向按钮 ↔️/↕️（设备会自动跟随）
8. **切换设备方向**：点击设备上方的方向按钮 ↔️/↕️
9. **新增设备**：使用编辑工具栏添加相机和摆轮
10. **新增分拣线**：使用工具栏创建自定义传送带路径
11. **保存更改**：点击保存按钮或自动保存
12. **快速操作**：`Ctrl+0` 重置缩放，`Ctrl+F` 适配屏幕，`Esc` 退出编辑

### 设备状态说明
- 🟢 **绿色**：设备在线，正常运行
- 🔴 **红色**：设备离线或故障
- 🟠 **橙色**：心跳超时，连接不稳定
- ⚪ **灰色**：未知状态

## 🎯 负载平衡功能

### 智能分拣
- **负载跟踪**：实时记录每个摆轮使用次数
- **平衡选择**：优先选择使用次数最少的摆轮
- **统计报告**：每100次分拣输出统计信息
- **平衡度评分**：提供0-100的平衡度评分

### 监控API
```javascript
// 查看摆轮使用统计
webSocketClient.getSorterUsageOverview();

// 查看详细负载平衡报告
webSocketClient.printSorterUsageReport();

// 重置所有统计
webSocketClient.resetAllSorterStats();
```

## 📱 设备兼容性

### 推荐环境
- **浏览器**：Chrome 90+, Firefox 88+, Safari 14+
- **分辨率**：1920×1080或更高
- **内存**：8GB以上系统内存

### 移动端支持
- **触摸操作**：支持单指拖拽、双指缩放
- **响应式界面**：自适应移动设备屏幕
- **性能优化**：针对移动设备优化渲染

## 🔄 无感配置同步功能

### 特性
- **自动保存**：配置变更后2秒自动保存到云端，无需手动操作
- **自动加载**：页面加载时自动拉取最新配置，每30秒定期检查更新
- **跨设备同步**：在任何设备修改配置，其他设备自动获取最新版本
- **团队协作**：多人共享同一配置，实现统一的界面布局
- **防抖机制**：避免频繁保存，优化网络性能
- **版本管理**：基于时间戳的智能版本比较和冲突处理

### 启用方法
1. **启动配置服务器**（端口3001）
2. **进入编辑模式** → 云端同步面板
3. **确认自动同步开关**已启用（默认开启）
4. **正常使用**，系统会自动在后台同步配置

### 同步内容
- 🎨 背景色设置
- 🌓 日夜间主题
- 📐 设备位置和布局
- ⚙️ 其他UI配置

> 详细说明请参考：[无感配置同步指南](AUTO-SYNC-GUIDE.md)

## 🔗 相关文档

- [无感配置同步指南](AUTO-SYNC-GUIDE.md) - 自动配置同步功能详解
- [编辑模式功能指南](README_EDITING_FEATURES.md) - 详细的编辑功能使用说明
- [后端服务文档](../warehouse-backend/README.md) - 后端服务配置和部署
- [心跳机制文档](../warehouse-backend/README_HEARTBEAT.md) - WebSocket心跳机制
- [分拣算法文档](../warehouse-backend/README_RANDOM_SORTING.md) - 智能分拣和负载平衡
- [配置服务器部署](../warehouse-config-server/README.md) - 配置管理服务器说明
- [Windows服务配置](../warehouse-config-server/WINDOWS-SERVICE.md) - 开机自启配置

## 🚧 开发指南

### 组件开发
```javascript
// 创建新的设备组件
<template>
  <v-group :config="groupConfig" @dragend="handleDragEnd">
    <!-- 设备图形元素 -->
  </v-group>
</template>

<script setup>
// 组件逻辑
const props = defineProps({
  config: { type: Object, required: true },
  isEditMode: { type: Boolean, default: false }
});
</script>
```

### 添加新路径
```javascript
// 在PathManager.js中添加新路径
const dynamicPaths = {
  new_path: { 
    direction: 'horizontal', 
    points: [
      { x: 100, y: 100 },
      { x: 200, y: 100 },
      { x: 300, y: 100 }
    ] 
  }
};
```

## 📝 更新日志

### v2.3.5 (最新)
- 🏷️ 传送带自定义名称功能：为传送带设置有意义的名称
- ✏️ 可视化名称编辑：编辑模式下点击铅笔图标编辑名称
- 🔌 WebSocket名称集成：支持通过传送带名称触发包裹动画
- 🔄 向后兼容处理：自动为现有传送带添加默认名称
- 📋 API接口：findPathByName(), triggerPackageByPathName(), getAllPathNames()

### v2.3.4
- 🧠 智能设备方向检测：根据设备所在传送带的实际方向设置默认方向
- 🔧 修复region区域设备：水平传送带上的设备方向现在正确
- 📍 几何位置检测：自动识别设备归属的传送带类型（垂直/水平）
- ✅ 完整布局兼容：支持混合布局（垂直+水平传送带）

### v2.3.3
- 🐛 修复摆轮方向错误：摆轮现在与传送带垂直而不是平行
- 🔧 修复相机位置跟随：保持相对位置关系，不强制重新定位  
- 📐 统一默认方向设置：摆轮默认水平，相机默认垂直
- ✅ 设备方向关系表：垂直传送带→水平摆轮，水平传送带→垂直摆轮

### v2.3.2
- 🐛 修复传送带首次方向切换时设备不跟随的问题
- 🔧 优化设备检测时序：预先记录设备列表避免检测失效
- 📊 增强调试日志：详细显示设备位置计算过程
- ✅ 确保设备与传送带保持正确的相对位置关系

### v2.3.1
- ✅ 新增设备智能跟随功能（传送带方向切换时设备自动跟随）
- ✅ 智能设备检测算法（50像素容差范围）
- ✅ 批量设备方向更新功能

### v2.3.0
- ✅ 新增传送带方向切换功能（垂直/水平）
- ✅ 新增相机方向切换功能（垂直/水平）
- ✅ 智能路径点重排算法
- ✅ 设备方向统一管理系统

### v2.2.0
- ✅ 新增完整的编辑工具栏界面
- ✅ 新增设备新增删除功能（相机、摆轮）
- ✅ 新增分拣线新增删除功能
- ✅ 新增摆轮方向切换功能（垂直/水平）
- ✅ 智能设备放置模式（点击放置+快速添加）
- ✅ 路径删除时自动清理关联设备
- ✅ 编辑工具栏主题适配和响应式设计

### v2.1.0
- ✅ 新增编辑模式缩放和平移功能
- ✅ 新增传送带路径反转功能
- ✅ 优化设备拖拽体验
- ✅ 改进节点编辑约束逻辑

### v2.0.0
- ✅ 摆轮负载平衡算法
- ✅ 智能分拣负载均衡
- ✅ 实时负载统计和平衡度评分

### v1.9.0
- ✅ 前后端心跳机制
- ✅ WebSocket连接状态监控
- ✅ 设备在线状态显示

## 🤝 贡献指南

1. Fork 项目
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开 Pull Request

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

---

💡 **提示**: 编辑功能强大，建议在了解业务流程的基础上进行布局调整。如需帮助，请参考[编辑模式功能指南](README_EDITING_FEATURES.md)。 